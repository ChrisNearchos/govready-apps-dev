id: issuepack
title: User Stories
instance-name: User Stories for {{jira_project_base_uri}}#{{jira_project_key}}
introduction:
  format: markdown
  template: |
    The best way to secure your system is during development.

    {{organization}} has prepared a set of security-related user stories for {{project}}'s product feature backlog.

    {% if match_jira_url(project.system_basics.issue_tracker) %}
    We already know your Jinja project is at {{match_jira_url(project.system_basics.issue_tracker).baseurl}}.
    {% endif %}

    Complete the following steps to automatically add these user stories to Jira.

external-functions:
  # This function is defined in issuepack.py.
  - match_jira_url

questions:
  - id: jira_project_base_uri
    title: Jira Project Base URI
    prompt: What is your Jira Project's base URI?
    type: url
    placeholder: https://myco.atlassian.net
    help: "Example: https://myco.atlassian.net"
    impute:
      - condition: match_jira_url(project.system_basics.issue_tracker) is not none
        value: match_jira_url(project.system_basics.issue_tracker).baseurl
        value-mode: expression

  - id: jira_project_key
    title: Jira Project Key
    prompt: What is your Jira Project Key at {{jira_project_base_uri}} (it prefixes all issues in project)?
    type: text
    impute:
      - condition: match_jira_url(project.system_basics.issue_tracker) is not none
        value: match_jira_url(project.system_basics.issue_tracker).key
        value-mode: expression

  - id: jira_username
    title: Jira Username
    prompt: What is your Jira username at {{jira_project_base_uri}}?
    type: text
    placeholder: username
    ask-first:
      - jira_project_key

  - id: jira_password
    title: Jira Password
    prompt: What is your Jira password for {{jira_username}} at {{jira_project_base_uri}}?
    type: password
    encrypt: emphemeral-user-key
    ask-first:
      - jira_project_key

  - id: create_issue_pack
    title: Create IssuePack
    prompt: Click Go to create the IssuePack.
    type: external-function
    function: create_issue_pack
    required: true # don't consider the module finished until this is run
    ask-first:
      - jira_project_base_uri
      - jira_project_key
      - jira_username
      - jira_password

output:
  - title: User Stories
    format: markdown
    template: |
      {% if not create_issue_pack %}
        The issues have not yet been created.
      {% elif create_issue_pack.status == "success" %}
        Congratulations, you've created user stories in Jira.
      {% else %}
        There was a problem creating the user stories. See the details for more information.
      {% endif %}

  - title: Details
    format: markdown
    template: |
      {% if create_issue_pack %}
      {{create_issue_pack.log}}
      {% endif %}


